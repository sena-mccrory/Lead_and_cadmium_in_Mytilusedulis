---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Decadal trends in cadmium and lead concentrations in *Mytilus edulis* samples from several European nations"
subtitle: "https://github.com/slm119/ENV872_FinalProject"
author: "Sena McCrory"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()

# Load your packages
library(tidyverse)
library(scales)
library(nationalparkcolors)
library(viridis)
library(cowplot)

# load data sets
mytilus.metals <- read.csv("./Data/Processed/ICES_Mytilusedulis_Cd_Pb.csv")
mytilus.metals$DATE <- as.Date(mytilus.metals$DATE, format = "%d/%m/%Y")

mytilus.pb.monthly_post1990.interp <- read.csv("./Data/Processed/pb_monthly_post1990_interp.csv")
mytilus.cd.monthly_post1990.interp <- read.csv("./Data/Processed/cd_monthly_post1990_interp.csv")
mytilus.pb.monthly_post1990.interp$Month.Year <- as.Date(mytilus.pb.monthly_post1990.interp$Month.Year, format = "%Y-%m-%d")
mytilus.cd.monthly_post1990.interp$Month.Year <- as.Date(mytilus.cd.monthly_post1990.interp$Month.Year, format = "%Y-%m-%d")

cd.pb.countries.combined <- read.csv("./Data/Processed/ICES_mytilusedulis_cd_pb_countriesmorethan100.csv")
cd.pb.countries.combined$DATE <- as.Date(cd.pb.countries.combined$DATE , format = "%Y-%m-%d")


detectionlimit.summary <- read.csv("./Data/Processed/DetectionLimitSummary_post1990_cd_pb.csv")

# aggregate by yearly median 1979 - 2018
yearly.data <- mytilus.metals %>%
   group_by(MYEAR, PARAM)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))

#subset post 1990
mytilus.post1990 <- mytilus.metals%>%
   filter(MYEAR >= 1990)%>%
   droplevels()
#summary(mytilus.post1990$QFLAG[mytilus.post1990$PARAM == "Cd"])
#summary(mytilus.post1990$QFLAG[mytilus.post1990$PARAM == "Pb"])

#change Country level order
mytilus.post1990$Country <- factor(mytilus.post1990$Country, levels = 
                                    c("Norway", "United Kingdom", 
                                      "Ireland", "Denmark", "The Netherlands",
                                      "Germany", "Spain", "Belgium", "Iceland", 
                                      "Poland", "Lithuania"))


# Set ggplot theme
my.theme <- theme_minimal(base_size = 14)+
  theme(legend.position = "top")
theme_set(my.theme)
my.colors <- park_palette("CraterLake")[c(5,7,1,2)]
```


# Rationale and Research Questions



\newpage

# Dataset Information



\newpage

# Exploratory Analysis 

The ICES database includes *Mytilus edulis* sample data from 1979 to 2018 for X European countries. Most samples were collected near shorelines and within some enclosed bay or lake areas (Fig 1).

```{r, echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, fig.cap="Yearly median concentrations of cadmium and lead in *Mytilus edulis* ICES monitoring data from 1979 to 2018."}
# yearly plot
ggplot(yearly.data, aes(x=MYEAR, y = Conc, color = PARAM))+
   geom_line(size = .8)+
   geom_point()+
   scale_color_manual(values = my.colors)+
   facet_wrap(~PARAM, nrow = 2, scales = "free_y")+
   theme(legend.position = "none")+
   labs(x = "Year", y = "Conc (mg metal/kg wet wt)")

```


```{r, echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, fig.cap="Sample locations from 1990 to 2018", out.width = '90%'}
#knitr::include_graphics("./Output/StudyRegionMap.png")
```


```{r, echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, fig.height = 2.5, fig.cap="Distirbution of sample concentrations of cadmium and lead in *Mytilus edulis* from ICES data 1990 to 2019."}
# #density plot
ggplot(mytilus.post1990, aes(x=Value.mgperkg, fill = PARAM))+
   geom_density()+
   scale_x_log10(labels = scales::comma)+
   scale_fill_manual(values = my.colors)+
   ylim(0,2)+
   facet_wrap(~PARAM, scales = "fixed", nrow = 1)+
   #coord_flip()+
   labs(x="Conc (mg/kg wet wt)", y = "Point Density", fill = "Metal")+
   theme(legend.position = "none")
```

```{r, echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, fig.height = 7, fig.cap="Cadmium and lead sample concentrations over time for ICES *Mytilus edulis* monitoring. Grey lines show the various instrument detection limits reported in each the data set."}
# all sample conc 1990 - 2018 - excluding one outlier in Cd for visualiztion purposes
cadmium.samples <- ggplot(mytilus.post1990 %>% 
          filter((PARAM == "Cd"  & Value.mgperkg != 0)), 
       aes(x=as.Date(DATE), y = Value.mgperkg))+
      geom_hline(yintercept = c(detectionlimit.summary$DETLI.mgperkg[detectionlimit.summary$PARAM =="Cd"]), alpha = .1)+
   geom_point(aes(color = PARAM), alpha = .5)+
   scale_color_manual(values = my.colors)+
   scale_y_log10(labels = scales::comma, limits = c(0.001,40))+
   labs(x= "Date", y = "mg Cd/kg wet wt", color = "Metal")+
   facet_wrap(~PARAM, scales = "fixed", ncol = 1)+
   theme(legend.position = "none", 
         axis.title.x = element_blank(),
         axis.text.x = element_blank(),
         panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

lead.samples <- ggplot(mytilus.post1990 %>% 
          filter((PARAM == "Pb"  & Value.mgperkg != 0)), 
       aes(x=as.Date(DATE), y = Value.mgperkg))+
      geom_hline(yintercept = c(detectionlimit.summary$DETLI.mgperkg[detectionlimit.summary$PARAM =="Pb"]), 
                 alpha = .1)+
   geom_point(aes(color = PARAM), alpha = .5)+
   scale_color_manual(values = my.colors[2])+
   scale_y_log10(labels = scales::comma, limits = c(.007,98.02))+
   labs(x= "Date", y = "mg Pb/kg wet wt", color = "Metal")+
   facet_wrap(~PARAM, scales = "fixed", ncol = 1)+
   theme(legend.position = "none",
         panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
   #geom_text(aes(x=as.Date("1994-12-01"), y = .6, label = "Maximum reported detection limit"), nudge_y = .1)
plot_grid(cadmium.samples, lead.samples,
          nrow = 2, align = "v", rel_heights = c(1,1.1))
  
```




\newpage

# Analysis

## Question 1: How have cadmium and lead concentrations in *Mytilus edulis* changed over time?


```{r, echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, fig.cap="Concentrations of cadmium and lead in *Mytilus edulis* in ICES study region from 1990 to 2018."}

cd.monthly.interp <- ggplot(mytilus.cd.monthly_post1990.interp, aes(x = as.Date(Month.Year), y = Conc))+
   #geom_line(color = my.colors[1])+
   geom_point(aes(shape = as.factor(estimated)), color = my.colors[1])+
   #geom_smooth(method = "lm", se = FALSE, color = my.colors[1])+
   scale_y_log10(labels = scales::comma)+
   scale_shape_manual(values = c(16,1), labels = c("actual", "interpolated"))+
   #coord_cartesian(ylim=c(0, 10))+
   theme(axis.text.x = element_blank())+
   labs(x= "", y = "mg Cd/kg wet wt", shape = "")+
   guides(shape = guide_legend(override.aes = list(color = "darkgray")))
   #stat_smooth_func(geom="text",method="lm",hjust=0,parse=TRUE) # need outviz package for this
   #scale_shape_discrete(values = c(16,1))
#cd.monthly.interp
pb.monthly.interp <- ggplot(subset(mytilus.pb.monthly_post1990.interp, Conc < 20), aes(x = as.Date(Month.Year), y = Conc))+
   #geom_line(color = my.colors[2])+
   scale_y_log10(labels = scales::comma)+
   geom_point(aes(shape = as.factor(estimated)), color = my.colors[2])+
   scale_shape_manual(values = c(16,1))+
   #geom_smooth(method = "lm", se = FALSE, color = my.colors[2])+
   #coord_cartesian(ylim=c(0, 10))+
   theme(legend.position = "none")+
   labs(x= "Date", y = "mg Pb/kg wet wt")
#pb.monthly.interp # remove that one really high outlier?? it is pulling the lm
plot_grid(cd.monthly.interp, pb.monthly.interp, nrow = 2)

```



## Question 2: Do cadmium and lead concentrations in *Mytilus edulis* differ by country?

```{r, echo=FALSE,error=FALSE, message=FALSE, warning=FALSE,fig.height=8, fig.cap="Concentrations of cadmium and lead in *Mytilus edulis* for countries with more than 100 samples between 1990 and 2018."}
# country violin
ggplot(cd.pb.countries.combined, aes(x=Country, y = Value.mgperkg, fill = PARAM))+
   geom_violin(draw_quantiles = .5)+
   scale_y_log10(labels = scales::comma)+
   scale_fill_manual(values = my.colors)+
   facet_wrap(~PARAM, nrow = 2)+
   theme(legend.position = "none",
         axis.text.x = element_text(angle = 45,  hjust = 1))

```



\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
