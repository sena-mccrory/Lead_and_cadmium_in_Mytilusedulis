---
title: "Analysis"
author: "Sena McCrory"
date: "4/10/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


## Setup
```{r}
getwd()
library(tidyverse)
library(viridis)
library(sf)
library(scales)
library(nationalparkcolors)
library(trend)
library(nlme)
library(piecewiseSEM)

mytilus.metals <- read.csv("./Data/Processed/ICES_Mytilusedulis_Cd_Pb.csv")
mytilus.metals$DATE <- as.Date(mytilus.metals$DATE, format = "%d/%m/%Y")

# theme
my.theme <- theme_minimal(base_size = 14)+
  theme(legend.position = "top")
theme_set(my.theme)
my.colors <- park_palette("CraterLake")[c(5,7,1,2)]


# create separate datasets for lead and cadmium, and filter for just post 1990
mytilus.pb <- mytilus.metals %>%
   filter(PARAM == "Pb" & MYEAR >= 1990)%>%
   droplevels()
mytilus.cd <- mytilus.metals %>%
   filter(PARAM == "Cd"& MYEAR >= 1990)%>%
   droplevels()
mytilus.cd.pb <- rbind(mytilus.cd, mytilus.pb)

# aggregate by monthly median
mytilus.pb.monthly_post1990 <- mytilus.pb%>%
   mutate(Month = format.Date(DATE, format = "%m"))%>%
   group_by(MYEAR,Month)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))%>%
   mutate(Month.Year = paste(MYEAR,Month,"01",sep = ""))
mytilus.pb.monthly_post1990$Month.Year <- as.Date(mytilus.pb.monthly_post1990$Month.Year, format = "%Y%m%d", origin = "1970-01-01")

mytilus.cd.monthly_post1990 <- mytilus.cd%>%
   mutate(Month = format.Date(DATE, format = "%m"))%>%
   group_by(MYEAR,Month)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))%>%
   mutate(Month.Year = paste(MYEAR,Month,"01",sep = ""))
mytilus.cd.monthly_post1990$Month.Year <- as.Date(mytilus.cd.monthly_post1990$Month.Year, format = "%Y%m%d", origin = "1970-01-01")
```

# monthly interpolation

```{r}
# subset and interpolate for after 1990
dim(mytilus.pb.monthly_post1990)
summary(mytilus.pb.monthly_post1990$MYEAR)
12*(2018-1990)-231
105/336 # about 1/3 of the sampling month are missing post 1990...is that okay to interp?

dim(mytilus.cd.monthly_post1990) # still have ~ 1/3 of months missing

```

interpolation for monthly time series analysis
```{r}
# monthly dataset to join
Months <- as.data.frame(seq(as.Date("1990-02-01"),as.Date("2018-12-01"), "month"))
colnames(Months)
Months <- Months %>%
rename(Month.Year = 'seq(as.Date(\"1990-02-01\"), as.Date(\"2018-12-01\"), \"month\")')
class(Months$Month.Year)

# spline interp - results in values < 0... not good
# cd
mytilus.cd.monthly_post1990.interp <- left_join(Months,mytilus.cd.monthly_post1990, by = "Month.Year")
mytilus.cd.monthly_post1990.interp$estimated <- ifelse(is.na(mytilus.cd.monthly_post1990.interp$Conc), 1, 0)
mytilus.cd.monthly_post1990.interp <- mytilus.cd.monthly_post1990.interp%>%
   select(Month.Year, Conc, estimated)
mytilus.cd.monthly_post1990.interp$Conc <- na.spline(mytilus.cd.monthly_post1990.interp$Conc)
# pb
mytilus.pb.monthly_post1990.interp <- left_join(Months,mytilus.pb.monthly_post1990, by = "Month.Year")
mytilus.pb.monthly_post1990.interp$estimated <- ifelse(is.na(mytilus.pb.monthly_post1990.interp$Conc), 1, 0)
mytilus.pb.monthly_post1990.interp <- mytilus.pb.monthly_post1990.interp%>%
   select(Month.Year, Conc, estimated)
mytilus.pb.monthly_post1990.interp$Conc <- na.spline(mytilus.pb.monthly_post1990.interp$Conc)


# linear interp na.approx...better
# cd
mytilus.cd.monthly_post1990.interp2 <- left_join(Months,mytilus.cd.monthly_post1990, by = "Month.Year")
mytilus.cd.monthly_post1990.interp2$estimated <- ifelse(is.na(mytilus.cd.monthly_post1990.interp2$Conc), 1, 0)
mytilus.cd.monthly_post1990.interp2 <- mytilus.cd.monthly_post1990.interp2%>%
   select(Month.Year, Conc, estimated)
mytilus.cd.monthly_post1990.interp2$Conc <- na.approx(mytilus.cd.monthly_post1990.interp2$Conc)
# pb
mytilus.pb.monthly_post1990.interp2 <- left_join(Months,mytilus.pb.monthly_post1990, by = "Month.Year")
mytilus.pb.monthly_post1990.interp2$estimated <- ifelse(is.na(mytilus.pb.monthly_post1990.interp2$Conc), 1, 0)
mytilus.pb.monthly_post1990.interp2 <- mytilus.pb.monthly_post1990.interp2%>%
   select(Month.Year, Conc, estimated)
mytilus.pb.monthly_post1990.interp2$Conc <- na.approx(mytilus.pb.monthly_post1990.interp2$Conc)

mytilus.cd.monthly_post1990.interp2$PARAM <- "Cd"
mytilus.pb.monthly_post1990.interp2$PARAM <- "Pb"

cd.pb.monthly.combined <- rbind(mytilus.cd.monthly_post1990.interp2, mytilus.pb.monthly_post1990.interp2)
```

```{r}
# write csvs of interpolated data
write.csv(mytilus.cd.monthly_post1990.interp2, "./Data/Processed/cd_monthly_post1990_interp.csv", row.names = FALSE)
write.csv(mytilus.pb.monthly_post1990.interp2, "./Data/Processed/pb_monthly_post1990_interp.csv", row.names = FALSE)

#seem to be a lot more weird stuff going on before 1990, fewer samples? 

#might be interesting to restrict the analysis to just post 1990? there is obviously a big decrease in pre 1990, but has the trend continued?
```

## how have metal concentrations in Mytilus edulis changed over time?

obvious decrease pre 1990, what about 1990 - 2018?
```{r}
# time series trend analysis by month
# cd
cd.monthly.ts <- ts(mytilus.cd.monthly_post1990.interp2$Conc,
                    frequency = 12,
                    start = c(1990,1,1),
                    end = c(2018,12,1))
cd.monthly.ts_trend <- smk.test(cd.monthly.ts)
cd.monthly.ts_trend
summary(cd.monthly.ts_trend) # starts on 1990 Feb, so month 1 is Feb
sea.sens.slope(cd.monthly.ts)

#pb
pb.monthly.ts <- ts(mytilus.pb.monthly_post1990.interp2$Conc,
                    frequency = 12,
                    start = c(1990,1,1),
                    end = c(2018,12,1))
pb.monthly.ts_trend <- smk.test(pb.monthly.ts)
pb.monthly.ts_trend
summary(pb.monthly.ts_trend)
sea.sens.slope(pb.monthly.ts)

#heirarchical model - with all sample data post 1990, Country as random effect
cd.changeovertime.mixed <- lme(data = mytilus.pb,
                               log(Value.mgperkg+1) ~ MYEAR,random = ~1|Country)
summary(cd.changeovertime.mixed)
rsquared(cd.changeovertime.mixed)
cd.changeovertime.fixed <- gls(data = mytilus.pb,
                               log(Value.mgperkg+1) ~ MYEAR)
summary(cd.changeovertime.fixed)
anova(cd.changeovertime.mixed, cd.changeovertime.fixed) # mixed is beter

# plot of monthly conc - with interpolated points
ggplot(cd.pb.monthly.combined, aes(x = as.Date(Month.Year), y = Conc, color = PARAM))+
   scale_color_manual(values = my.colors)+
   geom_line()+
   geom_point(aes(shape = as.factor(estimated)))+
   scale_shape_manual(values = c(16,1))+
   facet_wrap(~PARAM, nrow = 2, scales = "free_y")+
   theme(legend.position = "none")+
   labs(x= "Date", y = "Conc of metal (mg/kg wet wt)")

ggplot(mytilus.cd.monthly_post1990.interp, aes(x = as.Date(Month.Year), y = Conc))+
   geom_line(color = my.colors[1])+
   geom_point(aes(shape = as.factor(estimated)), color = my.colors[1])+
   scale_shape_manual(values = c(16,1))+
   #coord_cartesian(ylim=c(0, 10))+
   theme(legend.position = "none")+
   labs(x= "Date", y = "Conc of metal (mg/kg wet wt)")
ggplot(mytilus.pb.monthly_post1990.interp, aes(x = as.Date(Month.Year), y = Conc))+
   geom_line(color = my.colors[2])+
   geom_point(aes(shape = as.factor(estimated)), color = my.colors[2])+
   scale_shape_manual(values = c(16,1))+
   coord_cartesian(ylim=c(0, 10))+
   theme(legend.position = "none")+
   labs(x= "Date", y = "Conc of metal (mg/kg wet wt)")

```


## do concentrations differ by country?
```{r}
country.order.cd <- mytilus.cd %>%
   group_by(Country)%>%
   tally(sort = T, name = "n_bycountry")

country.order.pb <- mytilus.pb%>%
   group_by(Country)%>%
   tally(sort = T, name = "n_bycountry")
# exclude countries with less than 100 samples

# add sample number by country to each df
mytilus.cd <- left_join(mytilus.cd, country.order.cd, by = "Country")
mytilus.pb <- left_join(mytilus.pb, country.order.pb, by = "Country")
mytilus.cd$Country <- reorder(mytilus.cd$Country, mytilus.cd$n_bycountry)
mytilus.pb$Country <- reorder(mytilus.pb$Country, mytilus.pb$n_bycountry)
summary(mytilus.cd$Country)

# filter to remove countries with fewer than 100 samples over the study period
cd.countries <- mytilus.cd %>%
   filter(n_bycountry > 100)%>%
   droplevels()
pb.countries <- mytilus.pb %>%
   filter(n_bycountry > 100)%>%
   droplevels()

# plot over time
ggplot(cd.countries %>% arrange(-n_bycountry), 
       aes(x= as.Date(DATE), y = Value.mgperkg, color = Country))+
   geom_point(position = position_dodge(), alpha = .7)+
   scale_color_viridis_d(end = .9, option = "viridis")+
   ylim(0,10)+
   geom_smooth(method = "lm", se = F)

ggplot(pb.countries %>% arrange(-n_bycountry), aes(x= as.Date(DATE), y = Value.mgperkg, color = Country))+
   geom_point(position = position_dodge(), alpha = .7)+
   scale_color_viridis_d(end = .9, option = "inferno")+
   geom_smooth(method = "lm", se = F)+
   coord_cartesian(ylim = c(0,20))


ancova.cd <- lm(log(Value.mgperkg+1) ~ MYEAR * Country, 
                data = cd.countries)
summary(ancova.cd)


ancova.pb <- lm(log(Value.mgperkg+1) ~ MYEAR * Country, data = pb.countries)
summary(ancova.pb)

```

