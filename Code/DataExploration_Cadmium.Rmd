---
title: "DataExploration"
author: "Sena McCrory"
date: "4/9/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup
```{r}
getwd()
library(tidyverse)
library(viridis)
library(sf)
library(scales)
library(nationalparkcolors)
library(lubridate)
library(cowplot)

mytilus.metals <- read.csv("./Data/Processed/ICES_Mytilusedulis_Cd_Pb_Hg_Cu.csv")
mytilus.metals$DATE <- as.Date(mytilus.metals$DATE, format = "%d/%m/%Y")

table(mytilus.metals$PARAM)

# filter just for Cadmium
mytilus.cd <- mytilus.metals %>%
   filter(PARAM == "Cd")%>%
   droplevels()

# set theme for figures
my.theme <- theme_minimal(base_size = 14)+
  theme(legend.position = "top")
theme_set(my.theme)
my.colors <- park_palette("CraterLake")[c(1,2,5,7)]

```

## distribution of data

FAO Codex Alimentarius Maximum Level for metals in mussels (bivalves)
Cadmium: 2 mg/kg
other metals don't have MLs established

```{r}

# create dataset with out major outliers for display purposed only
mytilus.cd.rmoutliers <- mytilus.cd %>%
          filter(Value.mgperkg < 30)
   

# points over time
ggplot(mytilus.cd.rmoutliers, aes(x=as.Date(DATE), y = Value.mgperkg))+
   geom_point(aes(color = PARAM), alpha = .5)+
   scale_color_manual(values = my.colors)+
   labs(x= "Date", y = "Log Concentration (mg/kg wet wt)", color = "Metal")+
   geom_hline(yintercept=2, linetype ="dashed")

#few samples for finland, latvia, lithuania

#histogram
ggplot(mytilus.cd.rmoutliers, aes(x=Value.mgperkg, fill = PARAM))+
   geom_histogram(bins = 40)+
   scale_x_log10(labels = trans_format("log10", math_format(10^.x)))+
   scale_fill_manual(values = my.colors)+
   labs(x="Log Concentration (mg/kg wet wt)", y = "Count", fill = "Metal")+
   geom_vline(xintercept=2, linetype ="dashed")
#log transform conc
```

## visualization for time series analysis
```{r}
ggplot(mytilus.metals, aes(x=MYEAR, y=1))+
   geom_point()+
   facet_wrap(~PARAM)
summary(mytilus.metals$MYEAR)
# looks like there is data for all four metals for all years between 1979 and 2018

# aggregate by year
mytilus.cd.yearly <- mytilus.cd %>%
   group_by(MYEAR)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))
ggplot(mytilus.cd.yearly, aes(x=MYEAR, y = Conc))+
   geom_line(color = my.colors[1], size = 1)

```
seem to be a lot more weird stuff going on before 1990, 
fewer samples? more noise?

might be interesting to restrict the analysis to just post 1990? there is obviously a big decrease in pre 1990, but has the trend continued?

## map of data
```{r}
# data
coastlines_global_wgs84 <- st_read("./Data/SpatialData/GSHHS_shp/l/GSHHS_l_L1.shp")

metal_points_wgs84 <- mytilus.metals %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, dim = "XY")
head(metal_points_wgs84)


# check crs - 
st_crs(coastlines_global_wgs84) <- 4326
st_crs(metal_points_wgs84) <- 4326

# create an ocean basemap - looks like ggmap doesn't work for far north coords, cannot reproject :( booooo

```


## create a study sampling area map

```{r}

pdf("./Output/StudyRegionMap.pdf", width = 8.5, height = 11)
ggplot()+
  geom_sf(data = coastlines_global_wgs84, fill = NA, lwd = .25, inherit.aes = FALSE)+
  geom_sf(aes(color = PARAM), data = metal_points_wgs84, inherit.aes = F,
          size = 1, alpha = 0.5, shape = 18)+ 
  scale_color_manual(values = my.colors) + 
  coord_sf(xlim=c(-30, 40), ylim = c(38, 72), crs = 4326)+
  labs(color = "Mytilus edulis\nsample locations")+
  theme_minimal()+
   theme(legend.position = "none", 
         panel.grid.major = element_blank(), 
         panel.grid.minor = element_blank())+
   facet_wrap(~PARAM)
dev.off()

#summary(ICES_ecoregions_wgs84$Ecoregion)

#class(cadmium_biota_wgs84$Value)
#ggplot(cadmium_biota_wgs84)+
#  geom_histogram(aes(x=Value))

```


