---
title: "DataExploration"
author: "Sena McCrory"
date: "4/9/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup
```{r}
getwd()
library(tidyverse)
library(viridis)
library(sf)
library(scales)
library(nationalparkcolors)
library(lubridate)
library(cowplot)
library(trend)
library(zoo)

mytilus.allmetals <- read.csv("./Data/Processed/ICES_Mytilusedulis_Cd_Pb_Hg_Cu.csv")
mytilus.metals$DATE <- as.Date(mytilus.metals$DATE, format = "%d/%m/%Y")

table(mytilus.metals$PARAM)

mytilus.metals <- mytilus.allmetals%>%
   filter(PARAM == "Pb" | PARAM == "Cd")

# create separate datasets for each contaminant?
mytilus.pb <- mytilus.metals %>%
   filter(PARAM == "Pb")%>%
   droplevels()
mytilus.cd <- mytilus.metals %>%
   filter(PARAM == "Cd")%>%
   droplevels()

class(mytilus.cd$DATE)


my.theme <- theme_minimal(base_size = 14)+
  theme(legend.position = "top")
theme_set(my.theme)
my.colors <- park_palette("CraterLake")[c(1,2,5,7)]

# create dataset with out major outliers for display purposes only
mytilus.metals.rmoutliers <- mytilus.metals%>%
          filter((PARAM == "Cd" & Value.mgperkg < 30)| 
                    PARAM =="Pb")

# aggregate by year
mytilus.cd.yearly <- mytilus.cd %>%
   group_by(MYEAR)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))
mytilus.cd.yearly$Metal <- "Cd"

mytilus.pb.yearly <- mytilus.pb %>%
   group_by(MYEAR)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))
mytilus.pb.yearly$Metal <- "Pb"

yearly.data <- rbind(mytilus.cd.yearly, mytilus.pb.yearly)

# aggregate by month
mytilus.pb.monthly <- mytilus.pb%>%
   mutate(Month = format.Date(DATE, format = "%m"))%>%
   group_by(MYEAR,Month)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))%>%
   mutate(Month.Year = paste(MYEAR,Month,"01",sep = ""))
mytilus.pb.monthly$Month.Year <- as.Date(mytilus.pb.monthly$Month.Year, format = "%Y%m%d", origin = "1970-01-01")
```

## distribution of data

FAO Codex Alimentarius Maximum Level for metals in mussels (bivalves)
Cadmium: 2 mg/kg
lead does not have FAO Maximum Level established

```{r}
# points over time
ggplot(mytilus.metals.rmoutliers, aes(x=as.Date(DATE), y = Value.mgperkg))+
   geom_point(aes(color = PARAM), alpha = .5)+
   scale_color_manual(values = my.colors)+
   #scale_y_log10(labels = trans_format("log10", math_format(10^.x)))+
   labs(x= "Date", y = "Log Concentration (mg/kg wet wt)", color = "Metal")+
   facet_wrap(~PARAM, scales = "free_y", ncol = 1)

#histogram
ggplot(mytilus.metals.rmoutliers, aes(x=Value.mgperkg, fill = PARAM))+
   geom_histogram(bins = 40)+
   scale_x_log10(labels = trans_format("log10", math_format(10^.x)))+
   scale_fill_manual(values = my.colors)+
   facet_wrap(~PARAM, scales = "fixed")+
   labs(x="Log Concentration (mg/kg wet wt)", y = "Count", fill = "Metal")
#log transform conc
```

## visualization for time series analysis
```{r}
# all data points
ggplot(mytilus.metals.rmoutliers, aes(x=MYEAR, y=1))+
   geom_point()+
   facet_wrap(~PARAM)
summary(mytilus.metals$MYEAR)
# looks like there is data for all four metals for all years between 1979 and 2018

# yearly plot
ggplot(yearly.data, aes(x=MYEAR, y = Conc, color = Metal))+
   geom_line(size = .8)+
   geom_point()+
   scale_color_manual(values = my.colors)+
   ylim(0,1)+
   facet_wrap(~Metal, nrow = 2, scales = "fixed")+
   theme(legend.position = "none")+
   labs(x = "Year", y = "Conc of metal (mg/kg wet wt)")

# monthly plot
ggplot(mytilus.pb.monthly, aes(x=as.Date(Month.Year), y = 1))+
   geom_point(color = my.colors[2], size = 1)
#looks like there are many months missing for sampling to use monthly data, especially before 1990
```

### setup for monthly interpolation
```{r}
# subset and interpolate for after 1990
mytilus.pb.monthly_post1990 <- mytilus.pb.monthly%>%
   filter(MYEAR >= 1990)
dim(mytilus.pb.monthly_post1990)
summary(mytilus.pb.monthly_post1990$MYEAR)
12*(2018-1990)-231
105/336 # about 1/3 of the sampling month are missing post 1990...is that okay to interp?

mytilus.cd.monthly <- mytilus.cd %>%
   mutate(Month = format.Date(DATE, format = "%m"))%>%
   group_by(MYEAR,Month)%>%
   dplyr::summarise(Conc = median(Value.mgperkg))%>%
   mutate(Month.Year = paste(MYEAR,Month,"01",sep = ""))
mytilus.cd.monthly$Month.Year <- as.Date(mytilus.cd.monthly$Month.Year, format = "%Y%m%d", origin = "1970-01-01")


ggplot(mytilus.cd.monthly, aes(x=as.Date(Month.Year), y = 1))+
   geom_point(color = my.colors[1], size = 1)+
   ylim(0,3)

mytilus.cd.monthly_post1990 <- mytilus.cd.monthly%>%
   filter(MYEAR >= 1990)
dim(mytilus.cd.monthly_post1990) # still have ~ 1/3 of months missing

```

interpolation for monthly time series analysis
```{r}
# monthly dataset to join
Months <- as.data.frame(seq(as.Date("1990-02-01"),as.Date("2018-12-01"), "month"))
colnames(Months)
Months <- Months %>%
rename(Month.Year = 'seq(as.Date(\"1990-02-01\"), as.Date(\"2018-12-01\"), \"month\")')
class(Months$Month.Year)

# spline interp
# cd
mytilus.cd.monthly_post1990.interp <- left_join(Months,mytilus.cd.monthly_post1990, by = "Month.Year")
mytilus.cd.monthly_post1990.interp$estimated <- ifelse(is.na(mytilus.cd.monthly_post1990.interp$Conc), 1, 0)
mytilus.cd.monthly_post1990.interp <- mytilus.cd.monthly_post1990.interp%>%
   select(Month.Year, Conc, estimated)
mytilus.cd.monthly_post1990.interp$Conc <- na.spline(mytilus.cd.monthly_post1990.interp$Conc)
# pb
mytilus.pb.monthly_post1990.interp <- left_join(Months,mytilus.pb.monthly_post1990, by = "Month.Year")
mytilus.pb.monthly_post1990.interp$estimated <- ifelse(is.na(mytilus.pb.monthly_post1990.interp$Conc), 1, 0)
mytilus.pb.monthly_post1990.interp <- mytilus.pb.monthly_post1990.interp%>%
   select(Month.Year, Conc, estimated)
mytilus.pb.monthly_post1990.interp$Conc <- na.spline(mytilus.pb.monthly_post1990.interp$Conc)


# linear interp na.approx
# cd
mytilus.cd.monthly_post1990.interp2 <- left_join(Months,mytilus.cd.monthly_post1990, by = "Month.Year")
mytilus.cd.monthly_post1990.interp2$estimated <- ifelse(is.na(mytilus.cd.monthly_post1990.interp2$Conc), 1, 0)
mytilus.cd.monthly_post1990.interp2 <- mytilus.cd.monthly_post1990.interp2%>%
   select(Month.Year, Conc, estimated)
mytilus.cd.monthly_post1990.interp2$Conc <- na.approx(mytilus.cd.monthly_post1990.interp2$Conc)
# pb
mytilus.pb.monthly_post1990.interp2 <- left_join(Months,mytilus.pb.monthly_post1990, by = "Month.Year")
mytilus.pb.monthly_post1990.interp2$estimated <- ifelse(is.na(mytilus.pb.monthly_post1990.interp2$Conc), 1, 0)
mytilus.pb.monthly_post1990.interp2 <- mytilus.pb.monthly_post1990.interp2%>%
   select(Month.Year, Conc, estimated)
mytilus.pb.monthly_post1990.interp2$Conc <- na.approx(mytilus.pb.monthly_post1990.interp2$Conc)



# write csvs of interpolated data
write.csv(mytilus.cd.monthly_post1990.interp2, "./Data/Processed/cd_monthly_post1990_interp.csv", row.names = FALSE)
write.csv(mytilus.pb.monthly_post1990.interp2, "./Data/Processed/pb_monthly_post1990_interp.csv", row.names = FALSE)
```
seem to be a lot more weird stuff going on before 1990, 
fewer samples? 

might be interesting to restrict the analysis to just post 1990? there is obviously a big decrease in pre 1990, but has the trend continued?

## map of data
```{r}
# data
coastlines_global_wgs84 <- st_read("./Data/SpatialData/GSHHS_shp/l/GSHHS_l_L1.shp")

metal_points_wgs84 <- mytilus.metals %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, dim = "XY")
head(metal_points_wgs84)


# check crs - 
st_crs(coastlines_global_wgs84) <- 4326
st_crs(metal_points_wgs84) <- 4326

# create an ocean basemap - looks like ggmap doesn't work for far north coords, cannot reproject :( booooo

```


## create a study sampling area map

```{r}

pdf("./Output/StudyRegionMap.pdf", width = 8.5, height = 11)
ggplot()+
  geom_sf(data = coastlines_global_wgs84, fill = NA, lwd = .25, inherit.aes = FALSE)+
  geom_sf(aes(color = PARAM), data = metal_points_wgs84, inherit.aes = F,
          size = 1, alpha = 0.5, shape = 18)+ 
  scale_color_manual(values = my.colors) + 
  coord_sf(xlim=c(-30, 40), ylim = c(38, 72), crs = 4326)+
  labs(color = "Mytilus edulis\nsample locations")+
  theme_minimal()+
   theme(legend.position = "none", 
         panel.grid.major = element_blank(), 
         panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "darkgray", 
                                     fill=NA, size=1))+
   facet_wrap(~PARAM, nrow = 2)
dev.off()

```


